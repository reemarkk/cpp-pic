name: build + test (clang-21)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - "**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================================================
  # BUILD (Linux) -> uploads build/**
  # =========================================================
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        target: [i386-linux, x86_64-linux, aarch64-linux]
    name: build-${{ matrix.target }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM/Clang 21 and Ninja
        shell: bash
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          sudo add-apt-repository -y "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-21 main"
          sudo apt-get update
          sudo apt-get install -y clang-21 lld-21 llvm-21 ninja-build
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-21 100
          sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-21 100
          sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-21 100
          sudo update-alternatives --install /usr/bin/llvm-objdump llvm-objdump /usr/bin/llvm-objdump-21 100
          sudo update-alternatives --install /usr/bin/llvm-objcopy llvm-objcopy /usr/bin/llvm-objcopy-21 100
          sudo update-alternatives --install /usr/bin/llvm-strings llvm-strings /usr/bin/llvm-strings-21 100
          clang --version
          ninja --version

      - name: Install i386 multilib support
        if: matrix.target == 'i386-linux'
        shell: bash
        run: |
          sudo apt-get install -y gcc-multilib g++-multilib

      - name: Build (${{ matrix.target }})
        shell: bash
        env:
          CC: clang-21
          CXX: clang++-21
        run: |
          target="${{ matrix.target }}"
          arch="${target%-*}"
          platform="${target##*-}"
          echo "=== BUILD: arch=$arch platform=$platform type=release ==="
          cmake -B build/$platform/$arch/release/cmake -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain-clang.cmake \
            -DARCHITECTURE=$arch \
            -DPLATFORM=$platform \
            -DBUILD_TYPE=release
          cmake --build build/$platform/$arch/release/cmake

      - name: Upload build artifacts (${{ matrix.target }})
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: build/**

  # =========================================================
  # TEST (Linux) -> downloads artifacts, runs SINGLE *.elf
  # - i386/x86_64 run natively
  # - aarch64 runs via QEMU (fixes Exec format error)
  # =========================================================
  test-linux:
    runs-on: ubuntu-22.04
    needs: [build-linux]
    strategy:
      fail-fast: false
      matrix:
        target: [i386-linux, x86_64-linux, aarch64-linux]
    name: test-${{ matrix.target }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts (${{ matrix.target }})
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: artifacts

      - name: Install i386 runtime support
        if: matrix.target == 'i386-linux'
        shell: bash
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y libc6:i386

      - name: Enable QEMU for aarch64 (Linux only)
        if: matrix.target == 'aarch64-linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support
          sudo update-binfmts --enable qemu-aarch64 || true
          qemu-aarch64-static --version || true

      - name: Locate and run produced ELF (PASS = exit code 0)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Artifact tree (top) ==="
          find artifacts -maxdepth 7 -type f | sed 's/^/  /'

          mapfile -t elfs < <(find artifacts -type f -name "*.elf")
          if [[ ${#elfs[@]} -eq 0 ]]; then
            echo "No .elf found in artifacts/"
            exit 1
          fi
          if [[ ${#elfs[@]} -gt 1 ]]; then
            echo "More than one .elf found (ambiguous):"
            printf '  %s\n' "${elfs[@]}"
            exit 1
          fi

          elf="${elfs[0]}"
          echo "=== TEST RUN: ${elf} ==="
          chmod +x "${elf}"
          "${elf}"
          rc=$?

          if [[ $rc -ne 0 ]]; then
            echo "❌ TEST FAIL: exit code $rc (expected 0)"
            exit $rc
          fi

          echo "✔ TEST PASS: exit code 0"

  # =========================================================
  # BUILD (Windows) -> uploads build/**
  # =========================================================
  build-windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        target: [i386-windows, x86_64-windows, aarch64-windows]
    name: build-${{ matrix.target }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM 21.x and Ninja
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Install Ninja
          choco install ninja -y
          ninja --version

          # Install LLVM
          $ver = "21.1.6"
          $exe = "LLVM-$ver-win64.exe"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$ver/$exe"

          Invoke-WebRequest -Uri $url -OutFile $exe
          Start-Process -FilePath ".\$exe" -ArgumentList "/S" -Wait

          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

          clang --version
          lld-link --version

      - name: Build (${{ matrix.target }})
        shell: pwsh
        run: |
          $target = "${{ matrix.target }}"
          $parts = $target -split "-"
          $arch = $parts[0]
          $platform = $parts[1]
          Write-Host "=== BUILD: arch=$arch platform=$platform type=release ==="
          cmake -B "build/$platform/$arch/release/cmake" -G Ninja "-DCMAKE_TOOLCHAIN_FILE=cmake/toolchain-clang.cmake" "-DARCHITECTURE=$arch" "-DPLATFORM=$platform" "-DBUILD_TYPE=release"
          cmake --build "build/$platform/$arch/release/cmake"

      - name: Upload build artifacts (${{ matrix.target }})
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: build/**

  # =========================================================
  # TEST (Windows x64 runner)
  # - Runs i386/x86_64 EXEs
  # - Skips aarch64-windows runtime test (needs Windows ARM64 runner)
  # =========================================================
  test-windows:
    runs-on: windows-2022
    needs: [build-windows]
    strategy:
      fail-fast: false
      matrix:
        target: [i386-windows, x86_64-windows, aarch64-windows]
    name: test-${{ matrix.target }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts (${{ matrix.target }})
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: artifacts

      - name: Locate and run produced EXE (PASS = exit code 0)
        if: matrix.target != 'aarch64-windows'
        shell: pwsh
        run: |
          Write-Host "=== Artifact tree ==="
          Get-ChildItem -Path artifacts -Recurse | ForEach-Object { $_.FullName }

          $exes = Get-ChildItem -Path artifacts -Recurse -Filter *.exe
          if ($exes.Count -eq 0) {
            throw "No .exe found in artifacts/"
          }
          if ($exes.Count -gt 1) {
            Write-Host "More than one .exe found (ambiguous):"
            $exes | ForEach-Object { Write-Host "  $($_.FullName)" }
            throw "Ambiguous .exe selection"
          }

          $exe = $exes[0].FullName
          Write-Host "=== TEST RUN: $exe ==="

          & $exe
          if ($LASTEXITCODE -ne 0) {
            throw "❌ TEST FAIL: exit code $LASTEXITCODE (expected 0)"
          }

          Write-Host "✔ TEST PASS: exit code 0"

      - name: Skip runtime test for aarch64-windows on x64 runner
        if: matrix.target == 'aarch64-windows'
        shell: pwsh
        run: |
          Write-Host "Skipping runtime test: ARM64 Windows binaries can't run on x64 Windows hosted runners."
          Write-Host "To test aarch64-windows, use a self-hosted Windows ARM64 runner (labels: self-hosted, windows, arm64)."